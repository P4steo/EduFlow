<!DOCTYPE html>
<html lang="pl">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta charset="UTF-8" />
  <title>Plan zjazdów DSW</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- DataTables + jQuery -->
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --bg-softer: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #020617 0%, #020617 40%, #020617 100%);
      border-right: 1px solid var(--border);
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
      z-index: 10;
    }

    .sidebar-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .app-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* KROPKA — STAN POCZĄTKOWY */
    .app-title span.logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #e0f2fe, #38bdf8);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.8);
    }

    .app-subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }

    /* ANIMACJA ODD BREATHING */
    @keyframes pulse-breath {
      0% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.15); }
      100% { opacity: 0.4; transform: scale(1); }
    }

    /* STAN ŁADOWANIA — NIEBIESKA PULSUJĄCA */
    .logo-dot.loading {
      background: #38bdf8 !important;
      animation: pulse-breath 1.2s ease-in-out infinite;
      box-shadow: 0 0 10px rgba(56,189,248,0.6);
    }

    /* STAN ZAŁADOWANO — ZIELONA */
    .logo-dot.loaded {
      background: #4ade80 !important;
      animation: none;
      box-shadow: 0 0 10px rgba(74,222,128,0.6);
    }

    /* STAN BŁĘDU — CZERWONA */
    .logo-dot.error {
      background: #f87171 !important;
      animation: none;
      box-shadow: 0 0 10px rgba(248,113,113,0.6);
    }

    /* STAN SPOCZYNKOWY — NIEBIESKA BEZ ANIMACJI */
    .logo-dot.idle {
      background: radial-gradient(circle at 30% 30%, #e0f2fe, #38bdf8);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.8);
    }

    /* RESZTA TWOJEGO CSS — BEZ ZMIAN */
    .filter-section {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-section h3 {
      margin: 0;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    select,
    button,
    input[type="date"] {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    select:focus,
    input[type="date"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }

    .date-modes {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .date-mode-btn {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-soft);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      white-space: nowrap;
    }

    .date-mode-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }

    .view-toggle {
      display: flex;
      gap: 6px;
    }

    .view-toggle button {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-soft);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
    }

    .view-toggle button.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
    }

    .status-box {
      margin-top: auto;
      font-size: 11px;
      color: var(--text-soft);
      padding-top: 8px;
      border-top: 1px dashed var(--border);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .status-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .status-pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      font-size: 10px;
      color: var(--text-soft);
    }

    .reload-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-soft);
      font-size: 11px;
      cursor: pointer;
    }

    .reload-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .main {
      flex: 1;
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .range-label {
      font-size: 13px;
      color: var(--text-soft);
    }

    .no-data {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px dashed var(--border);
      background: rgba(15, 23, 42, 0.7);
      font-size: 13px;
      color: var(--text-soft);
      display: none;
    }

    .cards-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .day-block {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .day-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .card {
      background: #020617;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px 9px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      position: relative;
    }

    .card.cancelled {
      opacity: 0.5;
      border-color: var(--danger);
    }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-soft);
    }

    .time {
      font-weight: 600;
      color: var(--accent);
    }

    .card-main {
      font-size: 13px;
      font-weight: 500;
    }

    .card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .card-meta span {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
    }

    .card-uwagi {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    /* Kolory grup – pastelowe */
    .card.group-1 { border-left: 4px solid #ff6b6b; }
    .card.group-2 { border-left: 4px solid #4dabf7; }
    .card.group-3 { border-left: 4px solid #51cf66; }
    .card.group-4 { border-left: 4px solid #845ef7; }
    .card.group-5 { border-left: 4px solid #ffa94d; }
    .card.group-6 { border-left: 4px solid #20c997; }
    .card.group-7 { border-left: 4px solid #e64980; }

    .table-container {
      display: none;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 10px;
    }

    table.dataTable {
      color: var(--text);
      font-size: 12px;
    }

    table.dataTable thead th {
      background: #020617;
      border-bottom: 1px solid var(--border);
    }

    table.dataTable tbody tr.cancelled {
      opacity: 0.5;
      color: var(--danger);
    }

    #customDates {
      display: none;
      gap: 6px;
    }

    #customDates input {
      font-size: 12px;
    }

    #mobileMenuBtn {
      display: none;
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 20;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text-soft);
      font-size: 12px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      .app {
        flex-direction: column;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: -320px;
        height: 100vh;
        width: 260px;
        transition: left 0.2s ease-out;
      }

      .sidebar.open {
        left: 0;
      }

      .main {
        padding-top: 44px;
      }

      #mobileMenuBtn {
        display: block;
      }
    }
  </style>
</head>
<body>

<button id="mobileMenuBtn">Filtry</button>

<div class="app">
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="app-title">
        <span class="logo-dot idle"></span>
        <span>Plan zjazdów DSW</span>
      </div>
      <div class="app-subtitle">Game Design • Game Art • Animacja 3D</div>
    </div>

    <div class="filter-section">
      <h3>Specjalizacja</h3>
      <select id="specSelect">
        <option value="1337">Animacja 3D</option>
        <option value="1336">Game Art i Concept Design</option>
        <option value="1335">Game Design</option>
      </select>
    </div>

    <div class="filter-section">
      <h3>Grupa</h3>
      <select id="groupSelect">
        <option value="all">Wszystkie</option>
      </select>
      <small style="font-size:11px;color:var(--text-soft);">
        „Moja grupa” = wybrana grupa + wykłady wspólne
      </small>
    </div>

    <div class="filter-section">
      <h3>Zakres dat</h3>
      <div class="date-modes">
        <button class="date-mode-btn active" data-mode="nearest">Najbliższy zjazd</button>
        <button class="date-mode-btn" data-mode="next">Następny</button>
        <button class="date-mode-btn" data-mode="all">Cały semestr</button>
        <button class="date-mode-btn" data-mode="custom">Własny</button>
      </div>
      <div id="customDates">
        <input type="date" id="startDate">
        <input type="date" id="endDate">
        <button id="applyCustomDates">OK</button>
      </div>
    </div>

    <div class="filter-section">
      <h3>Widok</h3>
      <div class="view-toggle">
        <button id="viewCards" class="active">Karty</button>
        <button id="viewTable">Tabela</button>
      </div>
    </div>

    <div class="status-box">
      <div class="status-line">
        <span class="status-pill" id="statusBox">Ładowanie…</span>
        <button class="reload-btn" id="reloadBtn">Odśwież</button>
      </div>
      <div style="font-size:11px;color:var(--text-soft);">
        <span id="currentRangeLabel">Najbliższy zjazd</span>
      </div>
    </div>
  </aside>

  <main class="main">
    <div id="noDataMessage" class="no-data">Ładowanie danych…</div>

    <div id="cardsContainer" class="cards-container"></div>

    <div id="tableContainer" class="table-container">
      <table id="planTable" style="width:100%;"></table>
    </div>
  </main>
</div>
<script>
const API_URL = "https://eduflow-qivy.onrender.com/plan";

let fullData = [];
let filteredData = [];
let table = null;

let currentView = "cards";
let currentDateMode = "nearest";
let currentTok = "1337";
let currentGroup = "all";

let lastTimestamp = null;

/* KROPKA — FUNKCJE STANÓW */
function setDotLoading() {
  const dot = document.querySelector(".logo-dot");
  dot.classList.remove("loaded", "error", "idle");
  dot.classList.add("loading");
}

function setDotLoaded() {
  const dot = document.querySelector(".logo-dot");
  dot.classList.remove("loading", "error", "idle");
  dot.classList.add("loaded");

  setTimeout(() => {
    dot.classList.remove("loaded");
    dot.classList.add("idle");
  }, 3000);
}

function setDotError() {
  const dot = document.querySelector(".logo-dot");
  dot.classList.remove("loading", "loaded", "idle");
  dot.classList.add("error");
}

/* FETCH + RETRY */
async function fetchPlanWithRetry(retries = 5, delay = 1500) {
  for (let i = 0; i < retries; i++) {
    try {
      const res = await fetch(`${API_URL}?tok=${currentTok}`);
      const json = await res.json();

      if (json && json.data && Array.isArray(json.data) && json.data.length > 0) {
        lastTimestamp = json.timestamp;
        return json.data;
      }
    } catch (e) {}

    await new Promise(resolve => setTimeout(resolve, delay));
  }
  return null;
}
/* WEEKEND HELPERS */
function nextWeekendDate(fromDate = new Date()) {
  const d = new Date(fromDate);
  while (true) {
    const day = d.getDay();
    if (day === 6 || day === 0) return d;
    d.setDate(d.getDate() + 1);
  }
}

function findNearestWeekendRange() {
  let d = new Date();

  for (let i = 0; i < 60; i++) {
    const saturday = nextWeekendDate(d);
    const sunday = new Date(saturday);

    if (saturday.getDay() === 6) {
      sunday.setDate(saturday.getDate() + 1);
    } else {
      saturday.setDate(saturday.getDate() - 1);
    }

    const satStr = saturday.toISOString().split("T")[0].replace(/-/g, ".");
    const sunStr = sunday.toISOString().split("T")[0].replace(/-/g, ".");

    const hasSat = fullData.some(item => item.data && item.data.includes(satStr));
    const hasSun = fullData.some(item => item.data && item.data.includes(sunStr));

    if (hasSat || hasSun) {
      return { sat: satStr, sun: sunStr };
    }

    d.setDate(saturday.getDate() + 2);
  }

  return null;
}

function findNextWeekendRange(currentRange) {
  const [y, m, d] = currentRange.sat.split(".").map(Number);
  const nextSat = new Date(y, m - 1, d + 7);
  const nextSun = new Date(nextSat);
  nextSun.setDate(nextSat.getDate() + 1);

  const satStr = nextSat.toISOString().split("T")[0].replace(/-/g, ".");
  const sunStr = nextSun.toISOString().split("T")[0].replace(/-/g, ".");

  return { sat: satStr, sun: sunStr };
}

/* FILTERING */
function filterByDateMode() {
  if (currentDateMode === "all") {
    document.getElementById("currentRangeLabel").textContent = "Cały semestr";
    return fullData.slice();
  }

  const nearest = findNearestWeekendRange();
  if (!nearest) {
    document.getElementById("currentRangeLabel").textContent = "Brak zjazdów w danych";
    return [];
  }

  if (currentDateMode === "nearest") {
    document.getElementById("currentRangeLabel").textContent =
      `Najbliższy zjazd: ${nearest.sat} – ${nearest.sun}`;

    return fullData.filter(item =>
      item.data && (item.data.includes(nearest.sat) || item.data.includes(nearest.sun))
    );
  }

  if (currentDateMode === "next") {
    const next = findNextWeekendRange(nearest);

    document.getElementById("currentRangeLabel").textContent =
      `Następny zjazd: ${next.sat} – ${next.sun}`;

    return fullData.filter(item =>
      item.data && (item.data.includes(next.sat) || item.data.includes(next.sun))
    );
  }

  return fullData.slice();
}

function filterByCustomDates(start, end) {
  const s = new Date(start);
  const e = new Date(end);

  const result = fullData.filter(item => {
    if (!item.data) return false;
    const d = new Date(item.data.replace(/\./g, "-"));
    return d >= s && d <= e;
  });

  document.getElementById("currentRangeLabel").textContent = `Zakres: ${start} – ${end}`;
  return result;
}

function applyGroupFilter(base) {
  if (currentGroup === "all") return base;

  return base.filter(item => {
    const group = item.group_code || "";
    const typ = (item.typ || "").toLowerCase();

    const isMyGroup = group === currentGroup;
    const isLecture = typ.includes("wyk");
    const isCommon = !group;

    return isMyGroup || isLecture || isCommon;
  });
}

/* GROUP FILTER UI */
function updateGroupFilter() {
  const select = document.getElementById("groupSelect");
  const groups = new Set();

  fullData.forEach(item => {
    if (item.group_code) groups.add(item.group_code);
  });

  const sorted = [...groups].sort((a, b) => a.localeCompare(b, "pl"));

  select.innerHTML = `<option value="all">Wszystkie</option>`;
  sorted.forEach(g => {
    select.innerHTML += `<option value="${g}">Grupa ${g}</option>`;
  });
}

/* RENDERING */
function updateNoDataMessage() {
  const msg = document.getElementById("noDataMessage");
  if (!filteredData || filteredData.length === 0) {
    msg.style.display = "block";
    msg.textContent = "Brak zajęć w wybranym zakresie.";
  } else {
    msg.style.display = "none";
  }
}

function applyAllFilters() {
  let base;

  if (currentDateMode === "custom") {
    const s = document.getElementById("startDate").value;
    const e = document.getElementById("endDate").value;
    if (s && e) {
      base = filterByCustomDates(s, e);
    } else {
      base = fullData.slice();
    }
  } else {
    base = filterByDateMode();
  }

  base = applyGroupFilter(base);

  filteredData = base;
  updateNoDataMessage();
  render();
}

function render() {
  if (currentView === "cards") {
    document.getElementById("cardsContainer").style.display = "flex";
    document.getElementById("tableContainer").style.display = "none";
    renderCards();
  } else {
    document.getElementById("cardsContainer").style.display = "none";
    document.getElementById("tableContainer").style.display = "block";
    renderTable();
  }
}

function groupByDate(data) {
  const map = {};
  data.forEach(item => {
    if (!map[item.data]) map[item.data] = [];
    map[item.data].push(item);
  });
  return Object.entries(map).sort((a, b) => new Date(a[0]) - new Date(b[0]));
}

function renderCards() {
  const container = document.getElementById("cardsContainer");
  container.innerHTML = "";

  const byDate = groupByDate(filteredData);

  byDate.forEach(([dateStr, items], i) => {
    if (i > 0) {
      const sep = document.createElement("hr");
      sep.style.margin = "10px 0";
      sep.style.borderColor = "rgba(31,41,55,0.7)";
      container.appendChild(sep);
    }

    const dayBlock = document.createElement("div");
    dayBlock.className = "day-block";

    const title = document.createElement("div");
    title.className = "day-title";
    title.textContent = dateStr;
    dayBlock.appendChild(title);

    items.sort((a, b) => {
      const t1 = new Date(`2000-01-01T${a.od}:00`);
      const t2 = new Date(`2000-01-01T${b.od}:00`);
      const diff = t1 - t2;
      if (diff !== 0) return diff;

      return (a.group_code || "").localeCompare(b.group_code || "");
    });

    items.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";

      if (item.group_code) {
        card.classList.add(`group-${item.group_code}`);
      }

      const uwagiLower = ((item.uwagi || "") + " " + (item.zaliczenie || "")).toLowerCase();
      if (uwagiLower.includes("odwołane")) {
        card.classList.add("cancelled");
      }

      const top = document.createElement("div");
      top.className = "card-top";

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = `${item.od}–${item.do}`;
      top.appendChild(time);

      card.appendChild(top);

      const main = document.createElement("div");
      main.className = "card-main";
      main.textContent = item.przedmiot || "Zajęcia";
      card.appendChild(main);

      const meta = document.createElement("div");
      meta.className = "card-meta";

      if (!item.group_code) {
        meta.innerHTML += `<span>Wykład</span>`;
      } else {
        meta.innerHTML += `<span>Grupa ${item.group_code}</span>`;
      }

      if (item.sala) meta.innerHTML += `<span>${item.sala}</span>`;
      if (item.prowadzacy) meta.innerHTML += `<span>${item.prowadzacy}</span>`;

      card.appendChild(meta);

      const uwagiParts = [];
      if (item.zaliczenie) uwagiParts.push(item.zaliczenie);
      if (item.uwagi && item.uwagi.toLowerCase() !== "brak") uwagiParts.push(item.uwagi);
      const uwagiDisplay = uwagiParts.join(", ");

      if (uwagiDisplay) {
        const uw = document.createElement("div");
        uw.className = "card-uwagi";
        uw.textContent = uwagiDisplay;
        card.appendChild(uw);
      }

      dayBlock.appendChild(card);
    });

    container.appendChild(dayBlock);
  });
}

function renderTable() {
  const rows = filteredData
    .sort((a, b) => {
      const d1 = new Date(a.data.replace(/\./g, "-"));
      const d2 = new Date(b.data.replace(/\./g, "-"));
      const diffDate = d1 - d2;
      if (diffDate !== 0) return diffDate;

      const t1 = new Date(`2000-01-01T${a.od}:00`);
      const t2 = new Date(`2000-01-01T${b.od}:00`);
      const diffTime = t1 - t2;
      if (diffTime !== 0) return diffTime;

      return (a.group_code || "").localeCompare(b.group_code || "");
    })
    .map(item => {
      const uwagiParts = [];
      if (item.zaliczenie) uwagiParts.push(item.zaliczenie);
      if (item.uwagi && item.uwagi.toLowerCase() !== "brak") uwagiParts.push(item.uwagi);
      const uwagiDisplay = uwagiParts.join(", ");

      return [
        item.data,
        item.od,
        item.do,
        item.group_code ? `Grupa ${item.group_code}` : "Wykład",
        item.przedmiot,
        item.sala,
        item.prowadzacy,
        uwagiDisplay
      ];
    });

  if (!table) {
    table = $('#planTable').DataTable({
      data: rows,
      columns: [
        { title: "Data" },
        { title: "Od" },
        { title: "Do" },
        { title: "Grupa / Wykład" },
        { title: "Zajęcia" },
        { title: "Sala" },
        { title: "Prowadzący" },
        { title: "Uwagi" }
      ],
      pageLength: 50,
      language: {
        url: "https://cdn.datatables.net/plug-ins/2.1.8/i18n/pl.json"
      },
      createdRow: function (row, data) {
        const uwagi = (data[7] || "").toLowerCase();
        if (uwagi.includes("odwołane")) {
          row.classList.add("cancelled");
        }
      }
    });
  } else {
    table.clear();
    table.rows.add(rows);
    table.draw();
  }
}
/* INIT */
async function init() {
  setDotLoading();
  document.getElementById("noDataMessage").textContent = "Ładowanie danych…";
  document.getElementById("noDataMessage").style.display = "block";

  const data = await fetchPlanWithRetry();

  if (!data) {
    document.getElementById("noDataMessage").textContent =
      "Brak danych z serwera. Spróbuj ponownie.";
    setDotError();
    return;
  }

  fullData = data;

  document.getElementById("statusBox").textContent =
    "Dane zaktualizowano: " +
    new Date(lastTimestamp * 1000).toLocaleString("pl-PL");

  document.getElementById("noDataMessage").style.display = "none";

  updateGroupFilter();
  applyAllFilters();
  setDotLoaded();
}

/* EVENTS */
document.getElementById("specSelect").addEventListener("change", e => {
  currentTok = e.target.value;
  init();
});

document.getElementById("groupSelect").addEventListener("change", e => {
  currentGroup = e.target.value;
  applyAllFilters();
});

document.querySelectorAll(".date-mode-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".date-mode-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentDateMode = btn.dataset.mode;
    document.getElementById("customDates").style.display =
      currentDateMode === "custom" ? "flex" : "none";
    applyAllFilters();
  });
});

document.getElementById("applyCustomDates").addEventListener("click", () => {
  currentDateMode = "custom";
  applyAllFilters();
});

document.getElementById("viewCards").addEventListener("click", () => {
  currentView = "cards";
  document.getElementById("viewCards").classList.add("active");
  document.getElementById("viewTable").classList.remove("active");
  render();
});

document.getElementById("viewTable").addEventListener("click", () => {
  currentView = "table";
  document.getElementById("viewTable").classList.add("active");
  document.getElementById("viewCards").classList.remove("active");
  render();
});

document.getElementById("reloadBtn").addEventListener("click", async () => {
  setDotLoading();
  document.getElementById("statusBox").textContent = "Odświeżanie…";
  document.getElementById("noDataMessage").style.display = "block";
  document.getElementById("noDataMessage").textContent = "Ładowanie danych…";

  const data = await fetchPlanWithRetry();

  if (!data) {
    document.getElementById("noDataMessage").textContent =
      "Brak danych z serwera. Spróbuj ponownie.";
    setDotError();
    return;
  }

  fullData = data;

  document.getElementById("statusBox").textContent =
    "Dane zaktualizowano: " +
    new Date(lastTimestamp * 1000).toLocaleString("pl-PL");

  updateGroupFilter();
  applyAllFilters();
  setDotLoaded();
});

/* MOBILE MENU */
const mobileBtn = document.getElementById("mobileMenuBtn");
const sidebar = document.querySelector(".sidebar");

function updateMobileMode() {
  if (window.innerWidth <= 768) {
    mobileBtn.style.display = "block";
  } else {
    mobileBtn.style.display = "none";
    sidebar.classList.remove("open");
  }
}

mobileBtn.addEventListener("click", () => {
  sidebar.classList.toggle("open");
});

document.addEventListener("click", (e) => {
  if (window.innerWidth > 768) return;
  if (!sidebar.contains(e.target) && e.target !== mobileBtn) {
    sidebar.classList.remove("open");
  }
});

window.addEventListener("resize", updateMobileMode);
updateMobileMode();

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
/* START */
init();
</script>
</body>
</html>




