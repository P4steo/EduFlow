<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>EduFlow – plan zajęć</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.min.css">

  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #d1d5db;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --danger-soft: #fee2e2;
      --danger-border: #fecaca;
      --day-separator: #9ca3af;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      background: #e5e7eb;
      border-right: 1px solid var(--border);
      padding: 20px;
      box-sizing: border-box;
    }

    .sidebar h1 {
      font-size: 20px;
      margin: 0 0 16px;
    }

    .sidebar section {
      margin-bottom: 20px;
    }

    .sidebar label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    .sidebar select,
    .sidebar button {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #f9fafb;
      font-size: 14px;
      cursor: pointer;
    }

    .sidebar button {
      margin-top: 6px;
      background: #e5e7eb;
    }

    .sidebar button.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--accent);
      font-weight: 600;
    }

    .view-toggle {
      display: flex;
      gap: 8px;
    }

    .view-toggle button {
      flex: 1;
    }

    .main {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
      overflow: auto;
    }

    .header-line {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
    }

    .header-line h2 {
      margin: 0;
      font-size: 18px;
    }

    .header-line span {
      font-size: 13px;
      color: var(--text-muted);
    }

    #reloadBtn {
      margin-left: 10px;
      padding: 6px 10px;
      border-radius: 6px;
      background: var(--accent-soft);
      border: 1px solid var(--accent);
      color: var(--accent);
      font-size: 13px;
      cursor: pointer;
    }

    #noDataMessage {
      margin-bottom: 12px;
      font-size: 13px;
      color: var(--text-muted);
      padding: 8px 10px;
      border-radius: 6px;
      background: #e5e7eb;
      display: none;
    }

    #tableContainer {
      display: none;
    }

    table.dataTable tbody tr.cancelled {
      background: var(--danger-soft) !important;
    }

    #cardsContainer {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .day-block {
      border-top: 1px solid var(--day-separator);
      padding-top: 10px;
      margin-top: 10px;
    }

    .day-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--day-separator);
      margin-bottom: 6px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card.cancelled {
      background: var(--danger-soft);
      border-color: var(--danger-border);
    }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .time {
      font-weight: 600;
    }

    .card-main {
      font-size: 14px;
      font-weight: 500;
    }

    .card-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .card-meta span {
      margin-right: 10px;
    }

    .card-uwagi {
      font-size: 12px;
      margin-top: 2px;
    }

    #statusBox {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #e5e7eb;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 12px;
      color: #374151;
      opacity: 0.85;
    }

    /* MOBILE MODE */
    @media (max-width: 768px) {

      body {
        flex-direction: column;
      }

      #mobileMenuBtn {
        display: block;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 9999;
        background: #2563eb;
        color: white;
        border: none;
        padding: 10px 14px;
        border-radius: 6px;
        font-size: 18px;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: -280px;
        width: 260px;
        height: 100vh;
        background: #e5e7eb;
        transition: left 0.3s ease;
        z-index: 9998;
        overflow-y: auto;
      }

      .sidebar.open {
        left: 0;
      }

      .main {
        margin-top: 60px;
        padding: 12px;
      }

      #cardsContainer {
        gap: 16px;
      }

      .card {
        padding: 14px;
      }

      #tableContainer {
        overflow-x: auto;
      }

      table {
        min-width: 900px;
      }

      .sidebar button,
      .sidebar select {
        padding: 10px 12px;
        font-size: 16px;
      }

      #statusBox {
        bottom: 70px;
        right: 10px;
      }
    }
  </style>
</head>
<body>

  <!-- HAMBURGER (mobile only) -->
  <button id="mobileMenuBtn" style="display:none;">☰</button>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <h1>EduFlow</h1>

    <!-- SPECJALIZACJA -->
    <section>
      <label for="specSelect">Specjalizacja</label>
      <select id="specSelect">
        <option value="1337">Animacja 3D</option>
        <option value="1336">Game Art i Concept Design</option>
        <option value="1335">Game Design</option>
      </select>
    </section>

    <!-- ZAKRES DAT -->
    <section>
      <label>Zakres dat</label>
      <button class="date-mode-btn active" data-mode="nearest">Najbliższy zjazd</button>
      <button class="date-mode-btn" data-mode="next">Następny zjazd</button>
      <button class="date-mode-btn" data-mode="all">Cały semestr</button>
      <button class="date-mode-btn" data-mode="custom">Własny zakres</button>

      <div id="customDates" style="margin-top:8px; display:none;">
        <input type="date" id="startDate" style="margin-bottom:4px; width:100%;">
        <input type="date" id="endDate" style="width:100%;">
        <button id="applyCustomDates" style="margin-top:4px;">Zastosuj</button>
      </div>
    </section>

    <!-- WIDOK -->
    <section>
      <label>Widok</label>
      <div class="view-toggle">
        <button id="viewCards" class="active">Karty</button>
        <button id="viewTable">Tabela</button>
      </div>
    </section>

    <!-- RELOAD -->
    <section>
      <button id="reloadBtn">Załaduj ponownie dane</button>
    </section>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main">
    <div class="header-line">
      <h2>Plan zajęć – DSW</h2>
      <span id="currentRangeLabel"></span>
    </div>

    <div id="noDataMessage">
      Brak danych do wyświetlenia. Wybierz inną datę lub poczekaj – dane są generowane.
    </div>

    <!-- KARTY -->
    <div id="cardsContainer"></div>

    <!-- TABELA -->
    <div id="tableContainer">
      <table id="planTable" class="display" style="width:100%">
        <thead>
          <tr>
            <th>Data</th>
            <th>Od</th>
            <th>Do</th>
            <th>Zajęcia</th>
            <th>Forma</th>
            <th>Sala</th>
            <th>Prowadzący</th>
            <th>Uwagi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <!-- STATUS -->
  <div id="statusBox">Ładowanie…</div>

  <!-- JS LIBS -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
<script>
const API_URL = "https://eduflow-qivy.onrender.com/plan";

let fullData = [];
let filteredData = [];
let table = null;

let currentView = "cards";
let currentDateMode = "nearest";
let currentTok = "1337"; // domyślnie Animacja 3D

let lastTimestamp = null;

/* ---------------------------------------------
   FETCH + RETRY
--------------------------------------------- */
async function fetchPlanWithRetry(retries = 5, delay = 1500) {
  for (let i = 0; i < retries; i++) {
    try {
      const res = await fetch(`${API_URL}?tok=${currentTok}`);
      const json = await res.json();

      if (json && json.data && Array.isArray(json.data) && json.data.length > 0) {
        lastTimestamp = json.timestamp;
        return json.data;
      }
    } catch (e) {}

    await new Promise(resolve => setTimeout(resolve, delay));
  }
  return null;
}

/* ---------------------------------------------
   WEEKEND HELPERS
--------------------------------------------- */
function nextWeekendDate(fromDate = new Date()) {
  const d = new Date(fromDate);
  while (true) {
    const day = d.getDay();
    if (day === 6 || day === 0) return d;
    d.setDate(d.getDate() + 1);
  }
}

function findNearestWeekendRange() {
  let d = new Date();

  for (let i = 0; i < 60; i++) {
    const saturday = nextWeekendDate(d);
    const sunday = new Date(saturday);

    if (saturday.getDay() === 6) {
      sunday.setDate(saturday.getDate() + 1);
    } else {
      saturday.setDate(saturday.getDate() - 1);
    }

    const satStr = saturday.toISOString().split("T")[0].replace(/-/g, ".");
    const sunStr = sunday.toISOString().split("T")[0].replace(/-/g, ".");

    const hasSat = fullData.some(item => item.data.includes(satStr));
    const hasSun = fullData.some(item => item.data.includes(sunStr));

    if (hasSat || hasSun) {
      return { sat: satStr, sun: sunStr };
    }

    d.setDate(saturday.getDate() + 2);
  }

  return null;
}

function findNextWeekendRange(currentRange) {
  const [y, m, d] = currentRange.sat.split(".").map(Number);
  const nextSat = new Date(y, m - 1, d + 7);
  const nextSun = new Date(nextSat);
  nextSun.setDate(nextSat.getDate() + 1);

  const satStr = nextSat.toISOString().split("T")[0].replace(/-/g, ".");
  const sunStr = nextSun.toISOString().split("T")[0].replace(/-/g, ".");

  return { sat: satStr, sun: sunStr };
}

/* ---------------------------------------------
   FILTERING
--------------------------------------------- */
function filterByDateMode() {
  if (currentDateMode === "all") {
    document.getElementById("currentRangeLabel").textContent = "Cały semestr";
    return fullData.slice();
  }

  const nearest = findNearestWeekendRange();
  if (!nearest) {
    document.getElementById("currentRangeLabel").textContent = "Brak zjazdów w danych";
    return [];
  }

  if (currentDateMode === "nearest") {
    document.getElementById("currentRangeLabel").textContent =
      `Najbliższy zjazd: ${nearest.sat} – ${nearest.sun}`;

    return fullData.filter(item =>
      item.data.includes(nearest.sat) || item.data.includes(nearest.sun)
    );
  }

  if (currentDateMode === "next") {
    const next = findNextWeekendRange(nearest);

    document.getElementById("currentRangeLabel").textContent =
      `Następny zjazd: ${next.sat} – ${next.sun}`;

    return fullData.filter(item =>
      item.data.includes(next.sat) || item.data.includes(next.sun)
    );
  }

  return fullData.slice();
}

function filterByCustomDates(start, end) {
  const s = new Date(start);
  const e = new Date(end);

  const result = fullData.filter(item => {
    const d = new Date(item.data.replace(/\./g, "-"));
    return d >= s && d <= e;
  });

  document.getElementById("currentRangeLabel").textContent = `Zakres: ${start} – ${end}`;
  return result;
}

/* ---------------------------------------------
   RENDERING
--------------------------------------------- */
function updateNoDataMessage() {
  const msg = document.getElementById("noDataMessage");
  if (!filteredData || filteredData.length === 0) {
    msg.style.display = "block";
  } else {
    msg.style.display = "none";
  }
}

function applyAllFilters() {
  let base;

  if (currentDateMode === "custom") {
    const s = document.getElementById("startDate").value;
    const e = document.getElementById("endDate").value;
    if (s && e) {
      base = filterByCustomDates(s, e);
    } else {
      base = fullData.slice();
    }
  } else {
    base = filterByDateMode();
  }

  filteredData = base;
  updateNoDataMessage();
  render();
}

function render() {
  if (currentView === "cards") {
    document.getElementById("cardsContainer").style.display = "flex";
    document.getElementById("tableContainer").style.display = "none";
    renderCards();
  } else {
    document.getElementById("cardsContainer").style.display = "none";
    document.getElementById("tableContainer").style.display = "block";
    renderTable();
  }
}

function groupByDate(data) {
  const map = {};
  data.forEach(item => {
    if (!map[item.data]) map[item.data] = [];
    map[item.data].push(item);
  });
  return Object.entries(map).sort((a, b) => new Date(a[0]) - new Date(b[0]));
}

function renderCards() {
  const container = document.getElementById("cardsContainer");
  container.innerHTML = "";

  const byDate = groupByDate(filteredData);

  byDate.forEach(([dateStr, items], i) => {
    if (i > 0) {
      const sep = document.createElement("hr");
      sep.style.margin = "10px 0";
      container.appendChild(sep);
    }

    const dayBlock = document.createElement("div");
    dayBlock.className = "day-block";

    const title = document.createElement("div");
    title.className = "day-title";
    title.textContent = dateStr;
    dayBlock.appendChild(title);

    items.sort((a, b) => a.od.localeCompare(b.od));

    items.forEach(item => {
      const card = document.createElement("div");
      card.className = "card";

      const uwagiLower = ((item.uwagi || "") + " " + (item.zaliczenie || "")).toLowerCase();
      if (uwagiLower.includes("odwołane")) {
        card.classList.add("cancelled");
      }

      const top = document.createElement("div");
      top.className = "card-top";

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = `${item.od}–${item.do}`;
      top.appendChild(time);

      card.appendChild(top);

      const main = document.createElement("div");
      main.className = "card-main";
      main.textContent = item.przedmiot || "Zajęcia";
      card.appendChild(main);

      const meta = document.createElement("div");
      meta.className = "card-meta";
      meta.innerHTML = `
        <span>${item.typ || ""}</span>
        <span>${item.sala || ""}</span>
        <span>${item.prowadzacy || ""}</span>
      `;
      card.appendChild(meta);

      const uwagiParts = [];
      if (item.zaliczenie) uwagiParts.push(item.zaliczenie);
      if (item.uwagi && item.uwagi.toLowerCase() !== "brak") uwagiParts.push(item.uwagi);
      const uwagiDisplay = uwagiParts.join(", ");

      if (uwagiDisplay) {
        const uw = document.createElement("div");
        uw.className = "card-uwagi";
        uw.textContent = uwagiDisplay;
        card.appendChild(uw);
      }

      dayBlock.appendChild(card);
    });

    container.appendChild(dayBlock);
  });
}

function renderTable() {
  const rows = filteredData
    .sort((a, b) => {
      const d = new Date(a.data.replace(/\./g, "-")) - new Date(b.data.replace(/\./g, "-"));
      if (d !== 0) return d;
      return a.od.localeCompare(b.od);
    })
    .map(item => {
      const uwagiParts = [];
      if (item.zaliczenie) uwagiParts.push(item.zaliczenie);
      if (item.uwagi && item.uwagi.toLowerCase() !== "brak") uwagiParts.push(item.uwagi);
      const uwagiDisplay = uwagiParts.join(", ");

      return [
        item.data,
        item.od,
        item.do,
        item.przedmiot,
        item.typ,
        item.sala,
        item.prowadzacy,
        uwagiDisplay
      ];
    });

  if (!table) {
    table = $('#planTable').DataTable({
      data: rows,
      columns: [
        { title: "Data" },
        { title: "Od" },
        { title: "Do" },
        { title: "Zajęcia" },
        { title: "Forma" },
        { title: "Sala" },
        { title: "Prowadzący" },
        { title: "Uwagi" }
      ],
      pageLength: 50,
      language: {
        url: "https://cdn.datatables.net/plug-ins/2.1.8/i18n/pl.json"
      },
      createdRow: function (row, data) {
        const uwagi = (data[7] || "").toLowerCase();
        if (uwagi.includes("odwołane")) {
          row.classList.add("cancelled");
        }
      }
    });
  } else {
    table.clear();
    table.rows.add(rows);
    table.draw();
  }
}

/* ---------------------------------------------
   INIT
--------------------------------------------- */
async function init() {
  document.getElementById("noDataMessage").textContent = "Ładowanie danych…";
  document.getElementById("noDataMessage").style.display = "block";

  const data = await fetchPlanWithRetry();

  if (!data) {
    document.getElementById("noDataMessage").textContent =
      "Brak danych z serwera. Spróbuj ponownie.";
    return;
  }

  fullData = data;

  document.getElementById("statusBox").textContent =
    "Dane zaktualizowano: " +
    new Date(lastTimestamp * 1000).toLocaleString("pl-PL");

  document.getElementById("noDataMessage").style.display = "none";

  applyAllFilters();
}

/* ---------------------------------------------
   EVENTS
--------------------------------------------- */
document.getElementById("specSelect").addEventListener("change", e => {
  currentTok = e.target.value;
  init();
});

document.querySelectorAll(".date-mode-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".date-mode-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    currentDateMode = btn.dataset.mode;
    document.getElementById("customDates").style.display =
      currentDateMode === "custom" ? "block" : "none";
    applyAllFilters();
  });
});

document.getElementById("applyCustomDates").addEventListener("click", () => {
  currentDateMode = "custom";
  applyAllFilters();
});

document.getElementById("viewCards").addEventListener("click", () => {
  currentView = "cards";
  document.getElementById("viewCards").classList.add("active");
  document.getElementById("viewTable").classList.remove("active");
  render();
});

document.getElementById("viewTable").addEventListener("click", () => {
  currentView = "table";
  document.getElementById("viewTable").classList.add("active");
  document.getElementById("viewCards").classList.remove("active");
  render();
});

document.getElementById("reloadBtn").addEventListener("click", async () => {
  document.getElementById("statusBox").textContent = "Odświeżanie…";
  document.getElementById("noDataMessage").style.display = "block";
  document.getElementById("noDataMessage").textContent = "Ładowanie danych…";

  const data = await fetchPlanWithRetry();

  if (!data) {
    document.getElementById("noDataMessage").textContent =
      "Brak danych z serwera. Spróbuj ponownie.";
    return;
  }

  fullData = data;

  document.getElementById("statusBox").textContent =
    "Dane zaktualizowano: " +
    new Date(lastTimestamp * 1000).toLocaleString("pl-PL");

  applyAllFilters();
});

/* ---------------------------------------------
   MOBILE MENU
--------------------------------------------- */
const mobileBtn = document.getElementById("mobileMenuBtn");
const sidebar = document.querySelector(".sidebar");

function updateMobileMode() {
  if (window.innerWidth <= 768) {
    mobileBtn.style.display = "block";
  } else {
    mobileBtn.style.display = "none";
    sidebar.classList.remove("open");
  }
}

mobileBtn.addEventListener("click", () => {
  sidebar.classList.toggle("open");
});

document.addEventListener("click", (e) => {
  if (window.innerWidth > 768) return;
  if (!sidebar.contains(e.target) && e.target !== mobileBtn) {
    sidebar.classList.remove("open");
  }
});

window.addEventListener("resize", updateMobileMode);
updateMobileMode();

/* ---------------------------------------------
   START
--------------------------------------------- */
init();
</script>

</body>
</html>
